<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TTRPG Tools — Herramientas de Mesa</title>
<link rel="stylesheet" href="css/style.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e94560">
</head>
<body>

<header class="site-header">
  <h1>TTRPG Tools <span>Herramientas de Mesa</span></h1>
  <nav class="site-nav" id="siteNav">
    <button class="nav-btn active" onclick="showHome()">Inicio</button>
    <button class="nav-btn" onclick="showSection('dice')">Dados</button>
    <button class="nav-btn" onclick="showSection('oracle')">Oraculo</button>
    <button class="nav-btn" onclick="showSection('tables')">Tablas</button>
    <button class="nav-btn" onclick="showSection('initiative')">Iniciativa</button>
    <button class="nav-btn" onclick="showSection('encounter')">Encuentros</button>
    <button class="nav-btn" onclick="showSection('npc')">NPCs</button>
    <button class="nav-btn" onclick="showSection('reference')">Ref</button>
    <button class="nav-btn" onclick="showSection('journal')">Diario</button>
    <button class="nav-btn" onclick="showSection('loot')">Loot</button>
    <button class="nav-btn" onclick="showSection('spells')">Spells</button>
    <button class="nav-btn" onclick="showSection('dungeon')">Dungeon</button>
    <button class="nav-btn cof-nav" onclick="showSection('cof')">CoF</button>
  </nav>
  <div class="ux-controls">
    <label class="ux-toggle" title="Auto-log al diario"><input type="checkbox" id="autoLogToggle" onchange="Journal.setAutoLog(this.checked)" checked>Auto-log</label>
    <button class="ux-btn" id="muteBtn" onclick="toggleMute()" title="Silenciar sonidos">&#x1F50A;</button>
  </div>
  <button class="compact-toggle" id="compactBtn" onclick="toggleCompact()" title="Modo Compacto">&#x25A3;</button>
  <div class="theme-picker">
    <button class="theme-btn" onclick="toggleThemeMenu()">&#x1F3A8;</button>
    <div class="theme-menu" id="themeMenu">
      <div class="theme-opt" onclick="setTheme('')"><span class="theme-swatch" style="background:#e94560"></span> Rojo Oscuro</div>
      <div class="theme-opt" onclick="setTheme('blue')"><span class="theme-swatch" style="background:#4a9eff"></span> Azul Noche</div>
      <div class="theme-opt" onclick="setTheme('green')"><span class="theme-swatch" style="background:#4ade80"></span> Verde Bosque</div>
      <div class="theme-opt" onclick="setTheme('parchment')"><span class="theme-swatch" style="background:#f4e8c1;border-color:#c4a86a"></span> Pergamino</div>
    </div>
  </div>
</header>

<main>

<!-- ====== HOME ====== -->
<div id="home">
  <div class="tools-grid">
    <div class="tool-card tc-red" onclick="showSection('dice')">
      <span class="tc-icon">&#x1F3B2;</span>
      <div class="tc-info"><h3>Tirador de Dados</h3><p>d4 a d100, ventaja/desventaja, formulas custom e historial</p></div>
    </div>
    <div class="tool-card tc-purple" onclick="showSection('oracle')">
      <span class="tc-icon">&#x1F52E;</span>
      <div class="tc-info"><h3>Oraculo Solo RPG</h3><p>Preguntas Si/No, eventos aleatorios, factor de caos y significado</p></div>
    </div>
    <div class="tool-card tc-gold" onclick="showSection('tables')">
      <span class="tc-icon">&#x1F4DC;</span>
      <div class="tc-info"><h3>Tablas Aleatorias</h3><p>Clima, encuentros, tesoro, trampas, mazmorras y mas</p></div>
    </div>
    <div class="tool-card tc-green" onclick="showSection('initiative')">
      <span class="tc-icon">&#x2694;&#xFE0F;</span>
      <div class="tc-info"><h3>Tracker de Iniciativa</h3><p>Orden de combate, condiciones, HP y contador de rondas</p></div>
    </div>
    <div class="tool-card tc-blue" onclick="showSection('encounter')">
      <span class="tc-icon">&#x1F409;</span>
      <div class="tc-info"><h3>Constructor de Encuentros</h3><p>Presupuestos XP del 2024 DMG con monstruos SRD filtrados por CR</p></div>
    </div>
    <div class="tool-card tc-cyan" onclick="showSection('npc')">
      <span class="tc-icon">&#x1F464;</span>
      <div class="tc-info"><h3>Generador de NPCs</h3><p>Nombre, stats, personalidad, apariencia, vinculo y motivacion</p></div>
    </div>
    <div class="tool-card tc-red" onclick="showSection('reference')" style="border-color:rgba(251,146,60,0.3);background:linear-gradient(135deg,rgba(251,146,60,0.08),var(--bg3))">
      <span class="tc-icon">&#x1F4D6;</span>
      <div class="tc-info"><h3>Referencia Rapida</h3><p>Acciones, condiciones, coberturas, descansos y reglas D&D 5.5</p></div>
    </div>
    <div class="tool-card tc-red" onclick="showSection('journal')" style="border-color:rgba(251,146,60,0.3);background:linear-gradient(135deg,rgba(201,162,39,0.08),var(--bg3))">
      <span class="tc-icon">&#x1F4D3;</span>
      <div class="tc-info"><h3>Diario de Sesion</h3><p>Log de sesion solo RPG con tracker de hilos y NPCs</p></div>
    </div>
    <div class="tool-card tc-gold" onclick="showSection('loot')" style="border-color:rgba(234,179,8,0.3);background:linear-gradient(135deg,rgba(234,179,8,0.08),var(--bg3))">
      <span class="tc-icon">&#x1F4B0;</span>
      <div class="tc-info"><h3>Generador de Loot</h3><p>Tesoro individual, hoard, items magicos por tier de CR</p></div>
    </div>
    <div class="tool-card tc-purple" onclick="showSection('spells')" style="border-color:rgba(168,85,247,0.3);background:linear-gradient(135deg,rgba(168,85,247,0.08),var(--bg3))">
      <span class="tc-icon">&#x2728;</span>
      <div class="tc-info"><h3>Spell Tracker</h3><p>Slots por nivel, concentracion, hechizos preparados D&D 5.5</p></div>
    </div>
    <div class="tool-card tc-green" onclick="showSection('dungeon')" style="border-color:rgba(34,197,94,0.3);background:linear-gradient(135deg,rgba(34,197,94,0.08),var(--bg3))">
      <span class="tc-icon">&#x1F3F0;</span>
      <div class="tc-info"><h3>Generador de Dungeons</h3><p>Mazmorras procedurales con trampas, monstruos y tesoro</p></div>
    </div>
    <div class="tool-card cof-card" onclick="showSection('cof')">
      <span class="tc-icon">&#x1F9B4;</span>
      <div class="tc-info"><h3>Choir of Flesh</h3><p>Character tracker, grid 5&#xD7;5, oraciones, viaje y referencia</p></div>
    </div>
  </div>
</div>

<!-- ====== COMPACT MODE ====== -->
<div id="compact-view">
  <div class="compact-panel" id="cp-dice">
    <h3>&#x1F3B2; Dados</h3>
    <div class="dice-quick">
      <button class="dice-btn" onclick="Dice.roll('1d4')">d4</button>
      <button class="dice-btn" onclick="Dice.roll('1d6')">d6</button>
      <button class="dice-btn" onclick="Dice.roll('1d8')">d8</button>
      <button class="dice-btn" onclick="Dice.roll('1d10')">d10</button>
      <button class="dice-btn" onclick="Dice.roll('1d12')">d12</button>
      <button class="dice-btn d20" onclick="Dice.roll('1d20')">d20</button>
      <button class="dice-btn" onclick="Dice.roll('1d100')">d100</button>
    </div>
    <div class="dice-adv">
      <button onclick="Dice.rollAdv(true)">Ventaja</button>
      <button onclick="Dice.rollAdv(false)">Desventaja</button>
    </div>
    <div class="dice-result" id="cpDiceRes">
      <div class="dice-val" id="cpDiceVal">--</div>
      <div class="dice-formula" id="cpDiceForm"></div>
    </div>
  </div>
  <div class="compact-panel" id="cp-oracle">
    <h3>&#x1F52E; Oraculo</h3>
    <div class="oracle-likelihood" id="cpOracleLikelihood"></div>
    <button class="btn btn-primary btn-small" onclick="Oracle.ask()" style="width:100%;margin-bottom:8px">Preguntar</button>
    <div class="oracle-result" id="cpOracleResult">
      <div class="oracle-answer" id="cpOracleAnswer">?</div>
      <div class="oracle-event" id="cpOracleEvent" style="display:none"></div>
    </div>
  </div>
  <div class="compact-panel" id="cp-init">
    <h3>&#x2694;&#xFE0F; Iniciativa</h3>
    <div class="input-row">
      <input type="text" id="cpInitName" placeholder="Nombre" style="flex:1" onkeypress="if(event.key==='Enter'){document.getElementById('initName').value=this.value;Initiative.add();this.value=''}">
      <input type="number" id="cpInitBonus" placeholder="+0" style="width:50px">
      <button class="btn btn-primary btn-small" onclick="document.getElementById('initName').value=document.getElementById('cpInitName').value;document.getElementById('initBonus').value=document.getElementById('cpInitBonus').value;Initiative.add();document.getElementById('cpInitName').value=''">+</button>
    </div>
    <button class="btn btn-primary btn-small" onclick="Initiative.nextTurn()" style="margin-bottom:6px">&#x25B6; Siguiente</button>
    <div class="init-list" id="cpInitList"></div>
  </div>
  <div class="compact-panel" id="cp-ref">
    <h3>&#x1F4D6; Referencia</h3>
    <div id="cpRefContent"></div>
  </div>
</div>

<!-- ====== DICE ROLLER ====== -->
<div class="tool-section" id="sec-dice">
  <div class="section-head">
    <span class="sh-icon">&#x1F3B2;</span>
    <h2>Tirador de Dados</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="dice-quick">
      <button class="dice-btn" onclick="Dice.roll('1d4')">d4</button>
      <button class="dice-btn" onclick="Dice.roll('1d6')">d6</button>
      <button class="dice-btn" onclick="Dice.roll('1d8')">d8</button>
      <button class="dice-btn" onclick="Dice.roll('1d10')">d10</button>
      <button class="dice-btn" onclick="Dice.roll('1d12')">d12</button>
      <button class="dice-btn d20" onclick="Dice.roll('1d20')">d20</button>
      <button class="dice-btn" onclick="Dice.roll('1d100')">d100</button>
    </div>
    <div class="dice-adv">
      <button onclick="Dice.rollAdv(true)">Ventaja (2d20&#x2191;)</button>
      <button onclick="Dice.rollAdv(false)">Desventaja (2d20&#x2193;)</button>
    </div>
    <div class="input-row">
      <input type="text" id="diceInput" placeholder="Ej: 2d6+3, 4d8-2" onkeypress="if(event.key==='Enter')Dice.rollCustom()" style="flex:1">
      <button class="btn btn-primary" onclick="Dice.rollCustom()">Tirar</button>
    </div>
    <div class="dice-result" id="diceRes">
      <div class="dice-val" id="diceVal">--</div>
      <div class="dice-formula" id="diceForm">Listo para tirar</div>
      <div class="dice-breakdown" id="diceBD"></div>
    </div>
    <div class="dice-hist-head"><span>Historial</span><button class="btn btn-small btn-secondary" onclick="Dice.clearHist()">Limpiar</button></div>
    <div class="dice-hist" id="diceHist"><div class="dice-hist-empty">No hay tiradas</div></div>
  </div>
</div>

<!-- ====== ORACLE ====== -->
<div class="tool-section" id="sec-oracle">
  <div class="section-head">
    <span class="sh-icon">&#x1F52E;</span>
    <h2>Oraculo Solo RPG</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>Pregunta Si/No</h3></div>
    <div class="chaos-meter">
      <label>Caos:</label>
      <div class="chaos-bar">
        <div class="chaos-pip" onclick="Oracle.setChaos(1)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(2)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(3)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(4)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(5)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(6)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(7)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(8)"></div>
        <div class="chaos-pip" onclick="Oracle.setChaos(9)"></div>
      </div>
      <span class="chaos-val" id="chaosVal">5</span>
    </div>
    <div class="oracle-likelihood" id="oracleLikelihood"></div>
    <div class="input-row" style="justify-content:center;gap:8px">
      <button class="btn btn-primary" onclick="Oracle.ask()" style="flex:none;padding:10px 24px;font-size:0.95em">&#x1F52E; Preguntar al Oraculo</button>
      <button class="btn btn-secondary" onclick="Oracle.sceneCheck()" title="Verificar escena">&#x1F3AC; Escena</button>
    </div>
    <div class="oracle-result" id="oracleResult">
      <div class="oracle-answer" id="oracleAnswer">Haz una pregunta</div>
      <div class="oracle-event" id="oracleEvent" style="display:none"></div>
      <div class="oracle-detail" id="oracleDetail"></div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>Significado Aleatorio</h3></div>
    <button class="btn btn-gold" onclick="Oracle.rollMeaning()">&#x2728; Generar Significado</button>
    <div class="meaning-result" id="meaningResult" style="margin-top:12px">
      <div class="meaning-words" id="meaningWords">Accion + Sujeto</div>
      <div class="meaning-label">Accion + Sujeto</div>
    </div>
  </div>
</div>

<!-- ====== RANDOM TABLES ====== -->
<div class="tool-section" id="sec-tables">
  <div class="section-head">
    <span class="sh-icon">&#x1F4DC;</span>
    <h2>Tablas Aleatorias</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="table-result" id="tableResult" style="display:none">
    <div class="table-result-val" id="tableResultVal"></div>
    <div class="table-result-src" id="tableResultSrc"></div>
  </div>
  <div class="panel">
    <div class="panel-head">
      <h3>Tablas Disponibles</h3>
      <button class="btn btn-small btn-secondary" onclick="Tables.showCustomForm()">+ Custom</button>
    </div>
    <div class="table-list" id="tableList"></div>
  </div>
  <div class="panel" id="customTableForm" style="display:none">
    <div class="panel-head"><h3>Nueva Tabla Custom</h3></div>
    <div class="input-row"><input type="text" id="ctName" placeholder="Nombre de la tabla" style="flex:1"></div>
    <div class="input-row"><input type="text" id="ctIcon" placeholder="Emoji (ej: &#x1F3B2;)" style="width:80px"><input type="text" id="ctDesc" placeholder="Descripcion" style="flex:1"></div>
    <div style="margin-bottom:10px">
      <label style="font-size:0.78em;color:var(--text2)">Entradas (una por linea):</label>
      <textarea id="ctEntries" rows="6" style="width:100%;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;resize:vertical"></textarea>
    </div>
    <div class="input-row"><button class="btn btn-primary" onclick="Tables.saveCustom()">Guardar</button><button class="btn btn-secondary" onclick="Tables.hideCustomForm()">Cancelar</button></div>
  </div>
</div>

<!-- ====== INITIATIVE ====== -->
<div class="tool-section" id="sec-initiative">
  <div class="section-head">
    <span class="sh-icon">&#x2694;&#xFE0F;</span>
    <h2>Tracker de Iniciativa</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="input-row">
      <input type="text" id="initName" placeholder="Nombre" style="flex:1" onkeypress="if(event.key==='Enter')Initiative.add()">
      <input type="number" id="initBonus" placeholder="Bonus" style="width:80px">
      <input type="text" id="initHP" placeholder="HP" style="width:70px">
      <button class="btn btn-primary" onclick="Initiative.add()">Agregar</button>
    </div>
    <div class="init-controls">
      <button class="btn btn-primary" onclick="Initiative.nextTurn()">&#x25B6; Siguiente</button>
      <button class="btn btn-secondary" onclick="Initiative.prevTurn()">&#x25C0; Anterior</button>
      <button class="btn btn-secondary" onclick="Initiative.reroll()">&#x1F504; Re-tirar</button>
      <button class="btn btn-danger" onclick="if(confirm('Limpiar todo?'))Initiative.reset()">&#x1F5D1; Limpiar</button>
      <div class="round-display" id="roundDisplay">Sin iniciar</div>
    </div>
  </div>
  <div class="init-list" id="initList"></div>
</div>

<!-- ====== ENCOUNTER BUILDER ====== -->
<div class="tool-section" id="sec-encounter">
  <div class="section-head">
    <span class="sh-icon">&#x1F409;</span>
    <h2>Constructor de Encuentros</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="enc-params">
      <div class="enc-field">
        <label>Nivel del Party</label>
        <input type="number" id="partyLevel" value="3" min="1" max="20" onchange="Encounter.updateBudget()">
      </div>
      <div class="enc-field">
        <label>Jugadores</label>
        <input type="number" id="partySize" value="4" min="1" max="10" onchange="Encounter.updateBudget()">
      </div>
      <button class="btn btn-danger btn-small" onclick="Encounter.clearSelected()" style="align-self:flex-end">Limpiar</button>
    </div>
    <div class="enc-budget">
      <div class="enc-budget-item"><span class="label">Baja</span><span class="value low" id="budgetLow">600</span></div>
      <div class="enc-budget-item"><span class="label">Moderada</span><span class="value moderate" id="budgetMod">900</span></div>
      <div class="enc-budget-item"><span class="label">Alta</span><span class="value high" id="budgetHigh">1600</span></div>
    </div>
    <div class="enc-total">
      <span>Total XP: <span class="total-xp" id="encTotalXP">0 XP</span></span>
      <span class="enc-diff" id="encDifficulty">Trivial</span>
    </div>
  </div>
  <div class="panel enc-selected">
    <div class="panel-head"><h3>Monstruos Seleccionados</h3></div>
    <div id="selectedMonsters"><div style="color:var(--text3);font-size:0.85em;text-align:center;padding:10px">Click en un monstruo para a&ntilde;adirlo</div></div>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>Monstruos SRD</h3></div>
    <div class="input-row">
      <input type="text" id="monsterSearch" placeholder="Buscar por nombre, tipo o CR..." style="flex:1" oninput="Encounter.filterMonsters()">
    </div>
    <div class="enc-monsters" id="monsterList"></div>
  </div>
</div>

<!-- ====== NPC GENERATOR ====== -->
<div class="tool-section" id="sec-npc">
  <div class="section-head">
    <span class="sh-icon">&#x1F464;</span>
    <h2>Generador de NPCs</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="input-row">
      <select id="npcRace">
        <option value="random">Raza: Aleatorio</option>
        <option value="human">Humano</option>
        <option value="elf">Elfo</option>
        <option value="dwarf">Enano</option>
        <option value="halfling">Halfling</option>
      </select>
      <select id="npcGender">
        <option value="random">Genero: Aleatorio</option>
        <option value="male">Masculino</option>
        <option value="female">Femenino</option>
      </select>
      <button class="btn btn-primary" onclick="NPC.generate()">&#x1F3B2; Generar NPC</button>
    </div>
  </div>
  <div class="npc-card" id="npcCard" style="display:none"></div>
</div>

<!-- ====== REFERENCE ====== -->
<div class="tool-section" id="sec-reference">
  <div class="section-head">
    <span class="sh-icon">&#x1F4D6;</span>
    <h2>Referencia Rapida D&amp;D 5.5</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="input-row">
      <input type="text" id="refSearch" placeholder="Buscar regla, condicion, accion..." style="flex:1" oninput="Reference.search()">
      <button class="btn btn-small btn-secondary" onclick="Reference.expandAll()">Abrir todo</button>
      <button class="btn btn-small btn-secondary" onclick="Reference.collapseAll()">Cerrar todo</button>
    </div>
  </div>
  <div id="refContent"></div>
</div>

<!-- ====== JOURNAL ====== -->
<div class="tool-section" id="sec-journal">
  <div class="section-head">
    <span class="sh-icon">&#x1F4D3;</span>
    <h2>Diario de Sesion</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="journal-layout">
    <div class="journal-main">
      <div class="panel">
        <div class="panel-head">
          <h3>Sesiones</h3>
          <button class="btn btn-small btn-primary" onclick="Journal.newSession()">+ Nueva Sesion</button>
        </div>
        <div id="sessionList"></div>
      </div>
      <div class="panel" id="journalEntryPanel" style="display:none">
        <div class="panel-head"><h3>Entradas</h3></div>
        <div class="entry-timeline" id="entryTimeline"></div>
        <div class="input-row">
          <select id="entryType" style="width:120px">
            <option value="narrativa">&#x1F4D6; Narrativa</option>
            <option value="oraculo">&#x1F52E; Oraculo</option>
            <option value="tirada">&#x1F3B2; Tirada</option>
            <option value="combate">&#x2694;&#xFE0F; Combate</option>
            <option value="nota">&#x1F4DD; Nota</option>
          </select>
          <textarea id="entryText" placeholder="Escribe lo que sucede..." rows="2" style="flex:1;padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;resize:vertical" onkeydown="if(event.key==='Enter'&&event.ctrlKey){Journal.addEntry()}"></textarea>
          <button class="btn btn-primary" onclick="Journal.addEntry()" style="align-self:flex-end">Agregar</button>
        </div>
      </div>
    </div>
    <div class="journal-sidebar">
      <div class="thread-panel">
        <h4>&#x1F534; Hilos <button class="btn btn-small btn-secondary" onclick="Journal.addThread()">+</button></h4>
        <div id="threadList"></div>
      </div>
      <div class="thread-panel">
        <h4>&#x1F464; NPCs <button class="btn btn-small btn-secondary" onclick="Journal.addNPC()">+</button></h4>
        <div id="npcList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ====== LOOT GENERATOR ====== -->
<div class="tool-section" id="sec-loot">
  <div class="section-head">
    <span class="sh-icon">&#x1F4B0;</span>
    <h2>Generador de Loot</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>Configuracion</h3></div>
    <div class="input-row">
      <div style="flex:1">
        <label style="font-size:0.8em;color:var(--text2)">Tier de CR</label>
        <select id="lootTier" style="width:100%">
          <option value="0-4">CR 0-4 (Bajo)</option>
          <option value="5-10">CR 5-10 (Medio)</option>
          <option value="11-16">CR 11-16 (Alto)</option>
          <option value="17+">CR 17+ (Legendario)</option>
        </select>
      </div>
      <div style="flex:1">
        <label style="font-size:0.8em;color:var(--text2)">Tabla de Items</label>
        <select id="lootMagicTable" style="width:100%">
          <option value="A">Tabla A (Common)</option>
          <option value="B">Tabla B (Uncommon)</option>
          <option value="C">Tabla C (Rare)</option>
          <option value="D">Tabla D (Very Rare)</option>
          <option value="F">Tabla F (Uncommon+)</option>
          <option value="G">Tabla G (Rare+)</option>
          <option value="H">Tabla H (Very Rare+)</option>
        </select>
      </div>
    </div>
    <div class="input-row" style="flex-wrap:wrap;gap:8px;margin-top:12px">
      <button class="btn btn-primary" onclick="Loot.quickLoot()">&#x26A1; Quick Loot</button>
      <button class="btn btn-gold" onclick="Loot.generateIndividual()">&#x1F4B0; Individual</button>
      <button class="btn btn-secondary" onclick="Loot.generateHoard()">&#x1F3F4;&#x200D;&#x2620;&#xFE0F; Hoard</button>
      <button class="btn btn-secondary" onclick="Loot.generateMagicItem()">&#x2728; Item Magico</button>
    </div>
  </div>
  <div class="loot-result" id="lootResult" style="display:none"></div>
</div>

<!-- ====== SPELL TRACKER ====== -->
<div class="tool-section" id="sec-spells">
  <div class="section-head">
    <span class="sh-icon">&#x2728;</span>
    <h2>Spell Tracker</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>Clase y Nivel</h3></div>
    <div class="input-row">
      <select id="spellClass" onchange="Spells.setClass()" style="flex:1">
        <option value="wizard">Wizard</option>
        <option value="cleric">Cleric</option>
        <option value="sorcerer">Sorcerer</option>
        <option value="bard">Bard</option>
        <option value="druid">Druid</option>
        <option value="warlock">Warlock</option>
        <option value="paladin">Paladin</option>
        <option value="ranger">Ranger</option>
        <option value="eldritch-knight">Eldritch Knight</option>
        <option value="arcane-trickster">Arcane Trickster</option>
      </select>
      <input type="number" id="spellLevel" value="1" min="1" max="20" style="width:70px" onchange="Spells.setClass()">
      <button class="btn btn-primary" onclick="Spells.longRest()">&#x1F319; Descanso Largo</button>
    </div>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>&#x1F52E; Spell Slots</h3></div>
    <div class="spell-slots-grid" id="spellSlotsGrid"></div>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>&#x1F3AF; Concentracion</h3></div>
    <div id="spellConcentration"></div>
    <button class="btn btn-small btn-secondary" onclick="Spells.setConcentration()" style="margin-top:8px">Establecer Concentracion</button>
  </div>
  <div class="panel">
    <div class="panel-head">
      <h3>&#x1F4D6; Hechizos Preparados</h3>
      <button class="btn btn-small btn-primary" onclick="Spells.addPrepared()">+ Agregar</button>
    </div>
    <div class="prepared-list" id="spellPreparedList"></div>
  </div>
</div>

<!-- ====== DUNGEON GENERATOR ====== -->
<div class="tool-section" id="sec-dungeon">
  <div class="section-head">
    <span class="sh-icon">&#x1F3F0;</span>
    <h2>Generador de Dungeons</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="panel">
    <div class="panel-head"><h3>Configuracion</h3></div>
    <div class="input-row">
      <div style="flex:1">
        <label style="font-size:0.8em;color:var(--text2)">Tamano</label>
        <select id="dungeonSize" style="width:100%">
          <option value="small">Pequena (5 salas)</option>
          <option value="medium" selected>Mediana (8 salas)</option>
          <option value="large">Grande (12 salas)</option>
        </select>
      </div>
      <div style="flex:1">
        <label style="font-size:0.8em;color:var(--text2)">Dificultad</label>
        <select id="dungeonDifficulty" style="width:100%">
          <option value="low">Baja (CR 0-4)</option>
          <option value="mid" selected>Media (CR 5-10)</option>
          <option value="high">Alta (CR 11+)</option>
        </select>
      </div>
    </div>
    <div class="input-row" style="margin-top:12px;gap:8px">
      <button class="btn btn-primary" onclick="Dungeon.generate()">&#x1F3F0; Generar Dungeon</button>
      <button class="btn btn-secondary" onclick="Dungeon.generateSingleRoom()">&#x1F6AA; Habitacion Individual</button>
    </div>
  </div>
  <div class="dungeon-result" id="dungeonResult" style="display:none"></div>
</div>

<!-- ====== CHOIR OF FLESH ====== -->
<div class="tool-section" id="sec-cof">
  <div class="section-head cof-head">
    <span class="sh-icon">&#x1F9B4;</span>
    <h2>Choir of Flesh</h2>
    <button class="back-btn" onclick="showHome()">&#x2190; Inicio</button>
  </div>
  <div class="cof-tabs">
    <button class="cof-tab-btn active" data-tab="character" onclick="CoF.showTab('character')">&#x2694;&#xFE0F; Personaje</button>
    <button class="cof-tab-btn" data-tab="combat" onclick="CoF.showTab('combat')">&#x1F5E1;&#xFE0F; Combate</button>
    <button class="cof-tab-btn" data-tab="travel" onclick="CoF.showTab('travel')">&#x1F5FA;&#xFE0F; Viaje</button>
    <button class="cof-tab-btn" data-tab="faith" onclick="CoF.showTab('faith')">&#x271D;&#xFE0F; Fe/Carne</button>
    <button class="cof-tab-btn" data-tab="settlement" onclick="CoF.showTab('settlement')">&#x1F3D8;&#xFE0F; Asent.</button>
    <button class="cof-tab-btn" data-tab="incursion" onclick="CoF.showTab('incursion')">&#x1F5FA;&#xFE0F; Incursion</button>
    <button class="cof-tab-btn" data-tab="ref" onclick="CoF.showTab('ref')">&#x1F4D6; Ref</button>
  </div>

  <!-- CHARACTER TAB -->
  <div class="cof-tab-content" id="cof-character">
    <div class="panel cof-panel" style="margin-bottom:12px">
      <div class="panel-head">
        <h3>&#x1F465; Personajes</h3>
        <div style="display:flex;gap:6px">
          <select id="cof-char-select" onchange="CoF.switchChar(this.value)" style="padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.85em"></select>
          <button class="btn btn-small btn-primary" onclick="CoF.newChar()">+ Nuevo</button>
          <button class="btn btn-small btn-danger" onclick="CoF.deleteChar()">&#x1F5D1;</button>
        </div>
      </div>
    </div>
    <div class="cof-char-grid">
      <div class="panel cof-panel">
        <div class="panel-head"><h3>&#x2694;&#xFE0F; Identidad</h3></div>
        <div class="cof-field-row">
          <div class="cof-field"><label>Nombre</label><input type="text" id="cof-name" onchange="CoF.updateField('name',this.value)" placeholder="Nombre del personaje"></div>
          <div class="cof-field"><label>Ocupaci&#xF3;n</label><input type="text" id="cof-occupation" onchange="CoF.updateField('occupation',this.value)" placeholder="Soldado, Herrero..."></div>
        </div>
        <div class="cof-field-row">
          <div class="cof-field"><label>Pecado</label><input type="text" id="cof-sin" onchange="CoF.updateField('sin',this.value)" placeholder="Ira, Codicia..."></div>
          <div class="cof-field"><label>Fragmento</label><input type="text" id="cof-shard" onchange="CoF.updateField('shard',this.value)" placeholder="Reliquia del pasado"></div>
          <div class="cof-field"><label>Perdici&#xF3;n</label><input type="text" id="cof-doom" onchange="CoF.updateField('doom',this.value)" placeholder="Tu maldici&#xF3;n"></div>
        </div>
      </div>

      <div class="panel cof-panel">
        <div class="panel-head"><h3>&#x1F4CA; Stats</h3></div>
        <div class="cof-stats-grid">
          <div class="cof-stat" onclick="CoF.rollStat('str')"><label>STR</label><input type="number" id="cof-stat-str" min="1" max="20" onchange="CoF.updateStat('str',this.value)" onclick="event.stopPropagation()"></div>
          <div class="cof-stat" onclick="CoF.rollStat('dex')"><label>DEX</label><input type="number" id="cof-stat-dex" min="1" max="20" onchange="CoF.updateStat('dex',this.value)" onclick="event.stopPropagation()"></div>
          <div class="cof-stat" onclick="CoF.rollStat('con')"><label>CON</label><input type="number" id="cof-stat-con" min="1" max="20" onchange="CoF.updateStat('con',this.value)" onclick="event.stopPropagation()"></div>
          <div class="cof-stat" onclick="CoF.rollStat('int')"><label>INT</label><input type="number" id="cof-stat-int" min="1" max="20" onchange="CoF.updateStat('int',this.value)" onclick="event.stopPropagation()"></div>
          <div class="cof-stat" onclick="CoF.rollStat('wil')"><label>WIL</label><input type="number" id="cof-stat-wil" min="1" max="20" onchange="CoF.updateStat('wil',this.value)" onclick="event.stopPropagation()"></div>
          <div class="cof-stat" onclick="CoF.rollStat('pre')"><label>PRE</label><input type="number" id="cof-stat-pre" min="1" max="20" onchange="CoF.updateStat('pre',this.value)" onclick="event.stopPropagation()"></div>
        </div>
        <div class="cof-derived" id="cof-derived"></div>
        <small style="color:var(--text3);display:block;text-align:center;margin-top:4px">Click en un stat para tirar check</small>
      </div>

      <div class="panel cof-panel">
        <div class="panel-head"><h3>&#x1F480; Humanity &amp; Anguish</h3></div>
        <div class="cof-tracker">
          <label>Humanity</label>
          <div class="cof-hum-bar-wrap">
            <div class="cof-hum-bar"><div class="cof-hum-fill" id="cof-humanity-bar"></div></div>
            <span class="cof-hum-val" id="cof-humanity-val">20</span>
          </div>
          <div class="cof-tracker-btns">
            <button class="btn btn-small btn-danger" onclick="CoF.adjustHumanity(-1)">-1</button>
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustHumanity(1)">+1</button>
          </div>
        </div>
        <div class="cof-tracker" style="margin-top:12px">
          <label>Anguish</label>
          <div class="cof-anguish-display">
            <span class="cof-anguish-num" id="cof-anguish-val">0</span>
            <div class="cof-tracker-btns">
              <button class="btn btn-small btn-danger" onclick="CoF.adjustAnguish(1)">+1</button>
              <button class="btn btn-small btn-secondary" onclick="CoF.adjustAnguish(-1)">-1</button>
              <button class="btn btn-small btn-primary" onclick="CoF.anguishCheck()" title="d20 vs Anguish actual">&#x1F3B2; Check</button>
            </div>
          </div>
        </div>
        <div class="cof-tracker" style="margin-top:12px">
          <label>Trauma</label>
          <div class="cof-anguish-display">
            <span class="cof-anguish-num" id="cof-trauma-val">0</span>
            <div class="cof-tracker-btns">
              <button class="btn btn-small btn-danger" onclick="CoF.adjustTrauma(1)">+1</button>
              <button class="btn btn-small btn-secondary" onclick="CoF.adjustTrauma(-1)">-1</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel cof-panel">
        <div class="panel-head"><h3>&#x1FA79; Heridas</h3></div>
        <div class="cof-injuries">
          <div>
            <label>Minor (0/8)</label>
            <div class="cof-pip-row" id="cof-minor-pips"></div>
          </div>
          <div>
            <label>Major (0/4)</label>
            <div class="cof-pip-row" id="cof-major-pips"></div>
          </div>
          <div class="cof-death-alert" id="cof-death-alert" style="display:none">&#x1F480; MUERTE — El personaje ha ca&#xED;do</div>
        </div>
        <div class="cof-postcombat">
          <span>Post-combate:</span>
          <button class="btn btn-small btn-primary" onclick="CoF.postCombatCheck(true)">&#x1FA79; Con suministros (INT)</button>
          <button class="btn btn-small btn-secondary" onclick="CoF.postCombatCheck(false)">&#x1F9B4; Sin suministros (CON)</button>
        </div>
      </div>

      <div class="panel cof-panel">
        <div class="panel-head">
          <h3>&#x1F3B2; Dados de Uso</h3>
          <button class="btn btn-small btn-primary" onclick="CoF.addResource()">+ Recurso</button>
        </div>
        <div id="cof-usage-list"></div>
      </div>
    </div>
    <div class="cof-result" id="cof-char-result" style="display:none"></div>
  </div>

  <!-- COMBAT TAB -->
  <div class="cof-tab-content" id="cof-combat" style="display:none">
    <div class="panel cof-panel">
      <div class="panel-head"><h3>&#x1F5E1;&#xFE0F; Grid de Combate 5&#xD7;5</h3></div>
      <div class="cof-grid-controls">
        <button class="btn btn-small btn-primary" onclick="CoF.addToken('player')">&#x2694;&#xFE0F; Jugador</button>
        <button class="btn btn-small btn-secondary" onclick="CoF.addToken('ally')">&#x1F6E1;&#xFE0F; Aliado</button>
        <button class="btn btn-small btn-danger" onclick="CoF.addToken('enemy')">&#x1F480; Enemigo</button>
        <button class="btn btn-small btn-gold" onclick="CoF.generateTerrain()">&#x1F5FA;&#xFE0F; Terreno</button>
        <button class="btn btn-small btn-secondary" onclick="if(confirm('Limpiar grid?'))CoF.clearGrid()">&#x1F5D1; Limpiar</button>
      </div>
      <div class="cof-grid" id="cof-grid"></div>
    </div>
    <div class="panel cof-panel">
      <div class="panel-head"><h3>&#x1FA79; Tirar Herida</h3></div>
      <div class="input-row">
        <select id="cof-wound-type">
          <option value="blunt">Contundente</option>
          <option value="slash">Cortante</option>
          <option value="pierce">Perforante</option>
          <option value="fire">Fuego</option>
          <option value="divine">Divino</option>
        </select>
        <button class="btn btn-small btn-secondary" onclick="CoF.rollWound('minor')">Minor</button>
        <button class="btn btn-small btn-danger" onclick="CoF.rollWound('major')">Major</button>
      </div>
    </div>
    <div class="cof-result" id="cof-combat-result" style="display:none"></div>
  </div>

  <!-- TRAVEL TAB -->
  <div class="cof-tab-content" id="cof-travel" style="display:none">
    <div class="panel cof-panel">
      <div class="panel-head"><h3>&#x1F5FA;&#xFE0F; Viaje — The Endless Travail</h3></div>
      <div class="cof-travel-stats">
        <div class="cof-travel-stat"><span class="label">D&#xED;a</span><span class="value" id="cof-travel-day">1</span></div>
        <div class="cof-travel-stat"><span class="label">Turno</span><span class="value" id="cof-travel-turn">0/4</span></div>
        <div class="cof-travel-stat"><span class="label">Raciones</span><span class="value" id="cof-travel-rations">0</span></div>
        <div class="cof-travel-stat">
          <span class="label">Rumors</span>
          <span class="value" id="cof-travel-rumors">0</span>
          <div style="display:flex;gap:4px;margin-top:4px">
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustRumors(-1)" style="padding:2px 6px">-</button>
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustRumors(1)" style="padding:2px 6px">+</button>
          </div>
        </div>
      </div>
      <div class="cof-travel-actions">
        <button class="btn btn-primary" onclick="CoF.travelMove()">&#x1F9ED; Mover (1 turno)</button>
        <button class="btn btn-secondary" onclick="CoF.scavenge()">&#x1F50D; Scavenging</button>
        <button class="btn btn-small btn-secondary" onclick="if(confirm('Reiniciar viaje?'))CoF.resetTravel()">&#x1F504; Reset</button>
      </div>
      <div style="margin-top:10px;padding:8px;background:var(--bg2);border-radius:6px;font-size:0.8em;color:var(--text3)">
        <strong>Reglas:</strong> 4 turnos/d&#xED;a. Al mover: d10 (1-5 = encuentro). 10 Rumors = acceso a Incursion. 1 raci&#xF3;n/d&#xED;a.
      </div>
    </div>
    <div class="cof-result" id="cof-travel-result" style="display:none"></div>
  </div>

  <!-- FAITH TAB -->
  <div class="cof-tab-content" id="cof-faith" style="display:none">
    <div class="panel cof-panel">
      <div class="panel-head"><h3>&#x271D;&#xFE0F; Oraciones (The Celestial Choir)</h3></div>
      <p style="color:var(--text2);font-size:0.85em;margin-bottom:12px">Invoca el poder del Coro Celestial. d100 + bonus de tier. &#x2265;100 = Ascensi&#xF3;n (muerte).</p>
      <div class="cof-prayer-grid">
        <button class="btn cof-prayer-btn" onclick="CoF.pray('minor')">
          <strong>Menor</strong><span>+0 | Reroll gratis</span><small>Cuesta 1 Anguish</small>
        </button>
        <button class="btn cof-prayer-btn" onclick="CoF.pray('standard')">
          <strong>Est&#xE1;ndar</strong><span>+10 | Milagro moderado</span><small>Curar minor, da&#xF1;ar</small>
        </button>
        <button class="btn cof-prayer-btn major" onclick="CoF.pray('major')">
          <strong>Mayor</strong><span>+25 | Milagro poderoso</span><small>Curar major, devastar</small>
        </button>
        <button class="btn cof-prayer-btn apocalyptic" onclick="CoF.pray('apocalyptic')">
          <strong>Apocal&#xED;ptica</strong><span>+50 | Poder absoluto</span><small>&#x26A0; Riesgo extremo</small>
        </button>
      </div>
    </div>
    <div class="panel cof-panel">
      <div class="panel-head"><h3>&#x1FAC0; Actos de Apostas&#xED;a (The Flesh That Feeds)</h3></div>
      <p style="color:var(--text2);font-size:0.85em;margin-bottom:12px">Consume una Semilla de Carne para obtener una mutaci&#xF3;n permanente. Cuesta Humanity.</p>
      <button class="btn btn-danger" onclick="CoF.apostasy()" style="width:100%">&#x1FAC0; Consumir Semilla de Carne</button>
    </div>
    <div class="cof-result" id="cof-faith-result" style="display:none"></div>
  </div>

  <!-- SETTLEMENT TAB -->
  <div class="cof-tab-content" id="cof-settlement" style="display:none">
    <div class="panel cof-panel">
      <div class="panel-head"><h3>&#x1F3D8;&#xFE0F; Asentamiento</h3></div>
      <div class="cof-field-row">
        <div class="cof-field"><label>Nombre</label><input type="text" id="cof-settle-name" onchange="CoF.updateSettlement('name',this.value)" placeholder="Nombre del asentamiento"></div>
      </div>
      <div class="cof-settlement-stats">
        <div class="cof-settle-stat">
          <span class="label">Poblacion</span>
          <span class="value" id="cof-settle-pop">5</span>
          <div style="display:flex;gap:4px;margin-top:4px">
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustSettlement('population',-1)">-</button>
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustSettlement('population',1)">+</button>
          </div>
        </div>
        <div class="cof-settle-stat">
          <span class="label">Tier</span>
          <span class="value" id="cof-settle-tier">Farmstead</span>
        </div>
        <div class="cof-settle-stat">
          <span class="label">Discontent</span>
          <span class="value" id="cof-settle-disc">0</span>
          <div style="display:flex;gap:4px;margin-top:4px">
            <button class="btn btn-small btn-danger" onclick="CoF.adjustSettlement('discontent',1)">+</button>
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustSettlement('discontent',-1)">-</button>
          </div>
        </div>
        <div class="cof-settle-stat">
          <span class="label">Renown</span>
          <span class="value" id="cof-settle-renown">0</span>
          <div style="display:flex;gap:4px;margin-top:4px">
            <button class="btn btn-small btn-secondary" onclick="CoF.adjustSettlement('renown',-1)">-</button>
            <button class="btn btn-small btn-primary" onclick="CoF.adjustSettlement('renown',1)">+</button>
          </div>
        </div>
        <div class="cof-settle-stat">
          <span class="label">Upkeep/mes</span>
          <span class="value" id="cof-settle-upkeep">3</span>
        </div>
      </div>
    </div>
    <div class="panel cof-panel">
      <div class="panel-head">
        <h3>&#x1F3D7;&#xFE0F; Edificios</h3>
        <button class="btn btn-small btn-primary" onclick="CoF.addBuilding()">+ Construir</button>
      </div>
      <div class="cof-building-list" id="cof-building-list"></div>
    </div>
    <div class="cof-result" id="cof-settlement-result" style="display:none"></div>
  </div>

  <!-- INCURSION TAB -->
  <div class="cof-tab-content" id="cof-incursion" style="display:none">
    <div class="panel cof-panel">
      <div class="panel-head">
        <h3>&#x1F5FA;&#xFE0F; Incursion 3&#xD7;3</h3>
        <button class="btn btn-small btn-primary" onclick="CoF.generateIncursion()">&#x1F3B2; Generar</button>
      </div>
      <p style="color:var(--text2);font-size:0.85em;margin-bottom:12px">Necesitas 10 Rumors para acceder. Grid de 9 Points of Interest unicos.</p>
      <div class="cof-incursion-grid" id="cof-incursion-grid"></div>
    </div>
    <div class="cof-result" id="cof-incursion-result" style="display:none"></div>
  </div>

  <!-- REFERENCE TAB -->
  <div class="cof-tab-content" id="cof-ref" style="display:none">
    <div class="panel">
      <div class="input-row">
        <input type="text" id="cof-ref-search" placeholder="Buscar regla, mec&#xE1;nica..." style="flex:1" oninput="CoF.searchRef()">
      </div>
    </div>
    <div id="cof-ref-content"></div>
  </div>
</div>

</main>

<footer class="site-footer">
  <div class="backup-panel">
    <button class="btn btn-small btn-secondary" onclick="exportBackup()">&#x1F4E5; Exportar Backup</button>
    <button class="btn btn-small btn-secondary" onclick="document.getElementById('importFile').click()">&#x1F4E4; Importar Backup</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)">
  </div>
  TTRPG Tools &mdash; Herramientas para D&D 5.5 (2024) y Solo RPG &mdash;
  <a href="https://github.com/AkkarinRothen/ttrpg-tools" target="_blank">GitHub</a>
  <button class="pwa-install" id="pwaInstall" onclick="installPWA()">&#x1F4F2; Instalar App</button>
</footer>

<!-- Mobile Bottom Bar -->
<div class="mobile-bar" id="mobileBar">
  <button onclick="Dice.roll('1d20')">&#x1F3B2; d20</button>
  <button onclick="showSection('oracle')">&#x1F52E;</button>
  <button onclick="showSection('journal')">&#x1F4D3;</button>
  <button onclick="showHome()">&#x1F3E0;</button>
</div>

<script src="js/eventbus.js"></script>
<script src="js/audio.js"></script>
<script src="js/dice.js"></script>
<script src="js/oracle.js"></script>
<script src="js/tables.js"></script>
<script src="js/initiative.js"></script>
<script src="js/encounter.js"></script>
<script src="js/npc.js"></script>
<script src="js/reference.js"></script>
<script src="js/journal.js"></script>
<script src="js/loot.js"></script>
<script src="js/spells.js"></script>
<script src="js/dungeon.js"></script>
<script src="js/cof.js"></script>
<script>
// === NAVIGATION ===
const sections = ['dice','oracle','tables','initiative','encounter','npc','reference','journal','loot','spells','dungeon','cof'];
let initialized = {};
let isCompact = false;

function showHome() {
  if (isCompact) { toggleCompact(); return; }
  document.getElementById('home').style.display = 'block';
  sections.forEach(s => document.getElementById('sec-'+s).classList.remove('active'));
  updateNav(null);
  history.replaceState(null, '', location.pathname);
}

function showSection(name) {
  if (isCompact) toggleCompact();
  document.getElementById('home').style.display = 'none';
  sections.forEach(s => {
    const el = document.getElementById('sec-'+s);
    if (s === name) el.classList.add('active');
    else el.classList.remove('active');
  });
  updateNav(name);
  lazyInit(name);
  history.replaceState(null, '', '#' + name);
}

function lazyInit(name) {
  if (initialized[name]) return;
  initialized[name] = true;
  if (name === 'dice') Dice.init();
  if (name === 'oracle') Oracle.init();
  if (name === 'tables') Tables.init();
  if (name === 'initiative') Initiative.init();
  if (name === 'encounter') Encounter.init();
  if (name === 'npc') NPC.init();
  if (name === 'reference') Reference.init();
  if (name === 'journal') Journal.init();
  if (name === 'loot') Loot.init();
  if (name === 'spells') Spells.init();
  if (name === 'dungeon') Dungeon.init();
  if (name === 'cof') CoF.init();
}

function updateNav(active) {
  document.querySelectorAll('.site-nav .nav-btn').forEach(btn => {
    const isHome = btn.textContent === 'Inicio';
    const target = btn.getAttribute('onclick')?.match(/showSection\('(\w+)'\)/)?.[1];
    btn.classList.toggle('active', active ? target === active : isHome);
  });
}

// === COMPACT MODE ===
function toggleCompact() {
  isCompact = !isCompact;
  document.body.classList.toggle('compact-mode', isCompact);
  document.getElementById('compactBtn').classList.toggle('active', isCompact);
  if (isCompact) {
    // Init all needed modules
    ['dice','oracle','initiative','reference'].forEach(lazyInit);
    document.getElementById('home').style.display = 'none';
    sections.forEach(s => document.getElementById('sec-'+s).classList.remove('active'));
  } else {
    showHome();
  }
}

// === THEMES ===
function toggleThemeMenu() {
  document.getElementById('themeMenu').classList.toggle('open');
}

function setTheme(name) {
  if (name) document.documentElement.setAttribute('data-theme', name);
  else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('ttrpg_theme', name);
  document.getElementById('themeMenu').classList.remove('open');
  // Update active state
  document.querySelectorAll('.theme-opt').forEach(opt => {
    const val = opt.getAttribute('onclick').match(/setTheme\('(.*)'\)/)?.[1] || '';
    opt.classList.toggle('active', val === name);
  });
}

// Close theme menu on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.theme-picker')) document.getElementById('themeMenu').classList.remove('open');
});

// Load saved theme
const savedTheme = localStorage.getItem('ttrpg_theme');
if (savedTheme) setTheme(savedTheme);

// === MUTE TOGGLE ===
function toggleMute() {
  const muted = SFX.toggleMute();
  document.getElementById('muteBtn').textContent = muted ? '\u{1F507}' : '\u{1F50A}';
}
// Init mute button state
if (SFX.isMuted()) document.getElementById('muteBtn').textContent = '\u{1F507}';
// Init auto-log toggle
document.getElementById('autoLogToggle').checked = localStorage.getItem('ttrpg_autolog') !== '0';

// === BACKUP ===
function exportBackup() {
  const data = {};
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('ttrpg_') || key.startsWith('cof_')) {
      data[key] = localStorage.getItem(key);
    }
  }
  const backup = { version: 3, date: new Date().toISOString(), data };
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ttrpg-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

function importBackup(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.data) { alert('Archivo de backup invalido'); return; }
      if (!confirm(`Importar backup del ${new Date(backup.date).toLocaleDateString()}? Esto sobreescribira los datos actuales.`)) return;
      Object.entries(backup.data).forEach(([k, v]) => localStorage.setItem(k, v));
      alert('Backup importado. Recargando...');
      location.reload();
    } catch { alert('Error al leer el archivo de backup'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// === PWA ===
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwaInstall').style.display = 'inline-block';
});

function installPWA() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('pwaInstall').style.display = 'none'; });
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// Handle hash on load
window.addEventListener('DOMContentLoaded', () => {
  const hash = location.hash.replace('#','');
  if (sections.includes(hash)) showSection(hash);
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  const idx = parseInt(e.key);
  if (idx >= 1 && idx <= sections.length) showSection(sections[idx-1]);
  if (e.key === 'Escape' || e.key === '0') showHome();
  if (e.key === 'c' || e.key === 'C') toggleCompact();
});
</script>
</body>
</html>
